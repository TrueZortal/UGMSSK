require 'rails_helper'

RSpec.describe "SummonedMinions", type: :request do
  describe "POST /update_drag" do
    context "Minions owner is trying to drag his own minion to a valid movement field" do
      let(:test_game) {
        Game.create(
          current_turn: 2,
          underway: true
        )
      }

      let(:test_player) {
        PvpPlayers.create(
          name: "test",
          mana: 10,
          max_mana: 10,
          summoning_zone: "top left",
          uuid: SecureRandom.uuid,
          game_id: test_game.id
        )
      }

      let(:second_test_field) {
        second_test_field = BoardField.create(
          x_position: 1,
          y_position: 1,
          terrain: 'grass',
          obstacle: false,
          offset:'',
          game_id: test_game.id
        )
      }

      let(:test_minion) {
        SummonedMinion.create(
          minion_type: 'skeleton',
          owner_id: test_player.id,
          owner: "test",
          health: 0,
          x_position: 0,
          y_position: 0,
          game_id: test_game.id,
          valid_moves:[second_test_field.id]
        )
      }

      let(:test_field) {
        BoardField.create(
          x_position: 0,
          y_position: 0,
          occupant_id: test_minion.id,
          occupant_type: test_minion.minion_type,
          terrain: 'grass',
          obstacle: false,
          offset:'',
          game_id: test_game.id
        )
      }

      let(:test_params) {
        {
          "from_field_id"=>"#{test_field.id}",
          "to_field_id"=>"#{second_test_field.id}",
          "id"=>"#{test_field.id}",
          "summoned_minion"=>{}
        }
      }
      subject {
        MinionStat.create!([{
          minion_type: 'skeleton archer', mana_cost: 2, health: 2, attack: 2, defense: 0, speed: 1, initiative: 3, range: 3, icon: '64x64SkellyArcher.png'
        },
         {
           minion_type: 'skeleton', mana_cost: 1, health: 5, attack: 1, defense: 0, speed: 2, initiative: 3, range: 1.5, icon: '64x64Skelly.png'
         }])

        test_turn = TurnTracker.create(game_id: test_game.id, turn_number: test_game.current_turn, player_id: test_player.id)
        test_board = BoardState.create(
          pathfinding_data: "{\"[0, 0]\":{\"[0, 1]\":1.0,\"[1, 0]\":1.0,\"[1, 1]\":1.4142135623730951},\"[0, 1]\":{\"[0, 0]\":1.0,\"[0, 2]\":1.0,\"[1, 0]\":1.4142135623730951,\"[1, 1]\":1.0,\"[1, 2]\":1.4142135623730951},\"[1, 0]\":{\"[0, 0]\":1.0,\"[0, 1]\":1.4142135623730951,\"[1, 1]\":1.0,\"[2, 0]\":1.0,\"[2, 1]\":1.4142135623730951},\"[1, 1]\":{\"[0, 0]\":1.4142135623730951,\"[0, 1]\":1.0,\"[0, 2]\":1.4142135623730951,\"[1, 0]\":1.0,\"[1, 2]\":1.0,\"[2, 0]\":1.4142135623730951,\"[2, 1]\":1.0,\"[2, 2]\":1.4142135623730951},\"[0, 2]\":{\"[0, 1]\":1.0,\"[0, 3]\":1.0,\"[1, 1]\":1.4142135623730951,\"[1, 2]\":1.0,\"[1, 3]\":1.4142135623730951},\"[1, 2]\":{\"[0, 1]\":1.4142135623730951,\"[0, 2]\":1.0,\"[0, 3]\":1.4142135623730951,\"[1, 1]\":1.0,\"[1, 3]\":1.0,\"[2, 1]\":1.4142135623730951,\"[2, 2]\":1.0},\"[0, 3]\":{\"[0, 2]\":1.0,\"[0, 4]\":1.0,\"[1, 2]\":1.4142135623730951,\"[1, 3]\":1.0,\"[1, 4]\":1.4142135623730951},\"[1, 3]\":{\"[0, 2]\":1.4142135623730951,\"[0, 3]\":1.0,\"[0, 4]\":1.4142135623730951,\"[1, 2]\":1.0,\"[1, 4]\":1.0,\"[2, 2]\":1.4142135623730951,\"[2, 4]\":1.4142135623730951},\"[0, 4]\":{\"[0, 3]\":1.0,\"[0, 5]\":1.0,\"[1, 3]\":1.4142135623730951,\"[1, 4]\":1.0,\"[1, 5]\":1.4142135623730951},\"[1, 4]\":{\"[0, 3]\":1.4142135623730951,\"[0, 4]\":1.0,\"[0, 5]\":1.4142135623730951,\"[1, 3]\":1.0,\"[1, 5]\":1.0,\"[2, 4]\":1.0,\"[2, 5]\":1.4142135623730951},\"[0, 5]\":{\"[0, 4]\":1.0,\"[0, 6]\":1.0,\"[1, 4]\":1.4142135623730951,\"[1, 5]\":1.0,\"[1, 6]\":1.4142135623730951},\"[1, 5]\":{\"[0, 4]\":1.4142135623730951,\"[0, 5]\":1.0,\"[0, 6]\":1.4142135623730951,\"[1, 4]\":1.0,\"[1, 6]\":1.0,\"[2, 4]\":1.4142135623730951,\"[2, 5]\":1.0,\"[2, 6]\":1.4142135623730951},\"[0, 6]\":{\"[0, 5]\":1.0,\"[0, 7]\":1.0,\"[1, 5]\":1.4142135623730951,\"[1, 6]\":1.0,\"[1, 7]\":1.4142135623730951},\"[1, 6]\":{\"[0, 5]\":1.4142135623730951,\"[0, 6]\":1.0,\"[0, 7]\":1.4142135623730951,\"[1, 5]\":1.0,\"[1, 7]\":1.0,\"[2, 5]\":1.4142135623730951,\"[2, 6]\":1.0,\"[2, 7]\":1.4142135623730951},\"[0, 7]\":{\"[0, 6]\":1.0,\"[1, 6]\":1.4142135623730951,\"[1, 7]\":1.0},\"[1, 7]\":{\"[0, 6]\":1.4142135623730951,\"[0, 7]\":1.0,\"[1, 6]\":1.0,\"[2, 6]\":1.4142135623730951,\"[2, 7]\":1.0},\"[2, 0]\":{\"[1, 0]\":1.0,\"[1, 1]\":1.4142135623730951,\"[2, 1]\":1.0,\"[3, 0]\":1.0,\"[3, 1]\":1.4142135623730951},\"[2, 1]\":{\"[1, 0]\":1.4142135623730951,\"[1, 1]\":1.0,\"[1, 2]\":1.4142135623730951,\"[2, 0]\":1.0,\"[2, 2]\":1.0,\"[3, 0]\":1.4142135623730951,\"[3, 1]\":1.0,\"[3, 2]\":1.4142135623730951},\"[2, 2]\":{\"[1, 1]\":1.4142135623730951,\"[1, 2]\":1.0,\"[1, 3]\":1.4142135623730951,\"[2, 1]\":1.0,\"[3, 1]\":1.4142135623730951,\"[3, 2]\":1.0,\"[3, 3]\":1.4142135623730951},\"[2, 4]\":{\"[1, 3]\":1.4142135623730951,\"[1, 4]\":1.0,\"[1, 5]\":1.4142135623730951,\"[2, 5]\":1.0,\"[3, 3]\":1.4142135623730951,\"[3, 4]\":1.0},\"[2, 5]\":{\"[1, 4]\":1.4142135623730951,\"[1, 5]\":1.0,\"[1, 6]\":1.4142135623730951,\"[2, 4]\":1.0,\"[2, 6]\":1.0,\"[3, 4]\":1.4142135623730951,\"[3, 6]\":1.4142135623730951},\"[2, 6]\":{\"[1, 5]\":1.4142135623730951,\"[1, 6]\":1.0,\"[1, 7]\":1.4142135623730951,\"[2, 5]\":1.0,\"[2, 7]\":1.0,\"[3, 6]\":1.0,\"[3, 7]\":1.4142135623730951},\"[2, 7]\":{\"[1, 6]\":1.4142135623730951,\"[1, 7]\":1.0,\"[2, 6]\":1.0,\"[3, 6]\":1.4142135623730951,\"[3, 7]\":1.0},\"[3, 0]\":{\"[2, 0]\":1.0,\"[2, 1]\":1.4142135623730951,\"[3, 1]\":1.0,\"[4, 0]\":1.0,\"[4, 1]\":1.4142135623730951},\"[3, 1]\":{\"[2, 0]\":1.4142135623730951,\"[2, 1]\":1.0,\"[2, 2]\":1.4142135623730951,\"[3, 0]\":1.0,\"[3, 2]\":1.0,\"[4, 0]\":1.4142135623730951,\"[4, 1]\":1.0,\"[4, 2]\":1.4142135623730951},\"[3, 2]\":{\"[2, 1]\":1.4142135623730951,\"[2, 2]\":1.0,\"[3, 1]\":1.0,\"[3, 3]\":1.0,\"[4, 1]\":1.4142135623730951,\"[4, 2]\":1.0,\"[4, 3]\":1.4142135623730951},\"[3, 3]\":{\"[2, 2]\":1.4142135623730951,\"[2, 4]\":1.4142135623730951,\"[3, 2]\":1.0,\"[3, 4]\":1.0,\"[4, 2]\":1.4142135623730951,\"[4, 3]\":1.0,\"[4, 4]\":1.4142135623730951},\"[3, 4]\":{\"[2, 4]\":1.0,\"[2, 5]\":1.4142135623730951,\"[3, 3]\":1.0,\"[4, 3]\":1.4142135623730951,\"[4, 4]\":1.0},\"[3, 6]\":{\"[2, 5]\":1.4142135623730951,\"[2, 6]\":1.0,\"[2, 7]\":1.4142135623730951,\"[3, 7]\":1.0,\"[4, 6]\":1.0,\"[4, 7]\":1.4142135623730951},\"[3, 7]\":{\"[2, 6]\":1.4142135623730951,\"[2, 7]\":1.0,\"[3, 6]\":1.0,\"[4, 6]\":1.4142135623730951,\"[4, 7]\":1.0},\"[4, 0]\":{\"[3, 0]\":1.0,\"[3, 1]\":1.4142135623730951,\"[4, 1]\":1.0,\"[5, 0]\":1.0,\"[5, 1]\":1.4142135623730951},\"[4, 1]\":{\"[3, 0]\":1.4142135623730951,\"[3, 1]\":1.0,\"[3, 2]\":1.4142135623730951,\"[4, 0]\":1.0,\"[4, 2]\":1.0,\"[5, 0]\":1.4142135623730951,\"[5, 1]\":1.0,\"[5, 2]\":1.4142135623730951},\"[4, 2]\":{\"[3, 1]\":1.4142135623730951,\"[3, 2]\":1.0,\"[3, 3]\":1.4142135623730951,\"[4, 1]\":1.0,\"[4, 3]\":1.0,\"[5, 1]\":1.4142135623730951,\"[5, 2]\":1.0,\"[5, 3]\":1.4142135623730951},\"[4, 3]\":{\"[3, 2]\":1.4142135623730951,\"[3, 3]\":1.0,\"[3, 4]\":1.4142135623730951,\"[4, 2]\":1.0,\"[4, 4]\":1.0,\"[5, 2]\":1.4142135623730951,\"[5, 3]\":1.0,\"[5, 4]\":1.4142135623730951},\"[4, 4]\":{\"[3, 3]\":1.4142135623730951,\"[3, 4]\":1.0,\"[4, 3]\":1.0,\"[5, 3]\":1.4142135623730951,\"[5, 4]\":1.0,\"[5, 5]\":1.4142135623730951},\"[4, 6]\":{\"[3, 6]\":1.0,\"[3, 7]\":1.4142135623730951,\"[4, 7]\":1.0,\"[5, 5]\":1.4142135623730951,\"[5, 6]\":1.0,\"[5, 7]\":1.4142135623730951},\"[4, 7]\":{\"[3, 6]\":1.4142135623730951,\"[3, 7]\":1.0,\"[4, 6]\":1.0,\"[5, 6]\":1.4142135623730951,\"[5, 7]\":1.0},\"[5, 0]\":{\"[4, 0]\":1.0,\"[4, 1]\":1.4142135623730951,\"[5, 1]\":1.0,\"[6, 0]\":1.0,\"[6, 1]\":1.4142135623730951},\"[5, 1]\":{\"[4, 0]\":1.4142135623730951,\"[4, 1]\":1.0,\"[4, 2]\":1.4142135623730951,\"[5, 0]\":1.0,\"[5, 2]\":1.0,\"[6, 0]\":1.4142135623730951,\"[6, 1]\":1.0,\"[6, 2]\":1.4142135623730951},\"[5, 2]\":{\"[4, 1]\":1.4142135623730951,\"[4, 2]\":1.0,\"[4, 3]\":1.4142135623730951,\"[5, 1]\":1.0,\"[5, 3]\":1.0,\"[6, 1]\":1.4142135623730951,\"[6, 2]\":1.0,\"[6, 3]\":1.4142135623730951},\"[5, 3]\":{\"[4, 2]\":1.4142135623730951,\"[4, 3]\":1.0,\"[4, 4]\":1.4142135623730951,\"[5, 2]\":1.0,\"[5, 4]\":1.0,\"[6, 2]\":1.4142135623730951,\"[6, 3]\":1.0,\"[6, 4]\":1.4142135623730951},\"[5, 4]\":{\"[4, 3]\":1.4142135623730951,\"[4, 4]\":1.0,\"[5, 3]\":1.0,\"[5, 5]\":1.0,\"[6, 3]\":1.4142135623730951,\"[6, 4]\":1.0,\"[6, 5]\":1.4142135623730951},\"[5, 5]\":{\"[4, 4]\":1.4142135623730951,\"[4, 6]\":1.4142135623730951,\"[5, 4]\":1.0,\"[5, 6]\":1.0,\"[6, 4]\":1.4142135623730951,\"[6, 5]\":1.0,\"[6, 6]\":1.4142135623730951},\"[5, 6]\":{\"[4, 6]\":1.0,\"[4, 7]\":1.4142135623730951,\"[5, 5]\":1.0,\"[5, 7]\":1.0,\"[6, 5]\":1.4142135623730951,\"[6, 6]\":1.0,\"[6, 7]\":1.4142135623730951},\"[5, 7]\":{\"[4, 6]\":1.4142135623730951,\"[4, 7]\":1.0,\"[5, 6]\":1.0,\"[6, 6]\":1.4142135623730951,\"[6, 7]\":1.0},\"[6, 0]\":{\"[5, 0]\":1.0,\"[5, 1]\":1.4142135623730951,\"[6, 1]\":1.0,\"[7, 0]\":1.0,\"[7, 1]\":1.4142135623730951},\"[6, 1]\":{\"[5, 0]\":1.4142135623730951,\"[5, 1]\":1.0,\"[5, 2]\":1.4142135623730951,\"[6, 0]\":1.0,\"[6, 2]\":1.0,\"[7, 0]\":1.4142135623730951,\"[7, 1]\":1.0,\"[7, 2]\":1.4142135623730951},\"[6, 2]\":{\"[5, 1]\":1.4142135623730951,\"[5, 2]\":1.0,\"[5, 3]\":1.4142135623730951,\"[6, 1]\":1.0,\"[6, 3]\":1.0,\"[7, 1]\":1.4142135623730951,\"[7, 2]\":1.0,\"[7, 3]\":1.4142135623730951},\"[6, 3]\":{\"[5, 2]\":1.4142135623730951,\"[5, 3]\":1.0,\"[5, 4]\":1.4142135623730951,\"[6, 2]\":1.0,\"[6, 4]\":1.0,\"[7, 2]\":1.4142135623730951,\"[7, 3]\":1.0,\"[7, 4]\":1.4142135623730951},\"[6, 4]\":{\"[5, 3]\":1.4142135623730951,\"[5, 4]\":1.0,\"[5, 5]\":1.4142135623730951,\"[6, 3]\":1.0,\"[6, 5]\":1.0,\"[7, 3]\":1.4142135623730951,\"[7, 4]\":1.0,\"[7, 5]\":1.4142135623730951},\"[6, 5]\":{\"[5, 4]\":1.4142135623730951,\"[5, 5]\":1.0,\"[5, 6]\":1.4142135623730951,\"[6, 4]\":1.0,\"[6, 6]\":1.0,\"[7, 4]\":1.4142135623730951,\"[7, 5]\":1.0,\"[7, 6]\":1.4142135623730951},\"[6, 6]\":{\"[5, 5]\":1.4142135623730951,\"[5, 6]\":1.0,\"[5, 7]\":1.4142135623730951,\"[6, 5]\":1.0,\"[6, 7]\":1.0,\"[7, 5]\":1.4142135623730951,\"[7, 6]\":1.0,\"[7, 7]\":1.4142135623730951},\"[6, 7]\":{\"[5, 6]\":1.4142135623730951,\"[5, 7]\":1.0,\"[6, 6]\":1.0,\"[7, 6]\":1.4142135623730951,\"[7, 7]\":1.0},\"[7, 0]\":{\"[6, 0]\":1.0,\"[6, 1]\":1.4142135623730951,\"[7, 1]\":1.0},\"[7, 1]\":{\"[6, 0]\":1.4142135623730951,\"[6, 1]\":1.0,\"[6, 2]\":1.4142135623730951,\"[7, 0]\":1.0,\"[7, 2]\":1.0},\"[7, 2]\":{\"[6, 1]\":1.4142135623730951,\"[6, 2]\":1.0,\"[6, 3]\":1.4142135623730951,\"[7, 1]\":1.0,\"[7, 3]\":1.0},\"[7, 3]\":{\"[6, 2]\":1.4142135623730951,\"[6, 3]\":1.0,\"[6, 4]\":1.4142135623730951,\"[7, 2]\":1.0,\"[7, 4]\":1.0},\"[7, 4]\":{\"[6, 3]\":1.4142135623730951,\"[6, 4]\":1.0,\"[6, 5]\":1.4142135623730951,\"[7, 3]\":1.0,\"[7, 5]\":1.0},\"[7, 5]\":{\"[6, 4]\":1.4142135623730951,\"[6, 5]\":1.0,\"[6, 6]\":1.4142135623730951,\"[7, 4]\":1.0,\"[7, 6]\":1.0},\"[7, 6]\":{\"[6, 5]\":1.4142135623730951,\"[6, 6]\":1.0,\"[6, 7]\":1.4142135623730951,\"[7, 5]\":1.0,\"[7, 7]\":1.0},\"[7, 7]\":{\"[6, 6]\":1.4142135623730951,\"[6, 7]\":1.0,\"[7, 6]\":1.0}}",
          game_id: test_game.id
        )
        post("/summoned_minions/#{test_field.id}/update_drag/", :params => test_params)
      }
      it { is_expected.to match(302) }
    end
  end
end
